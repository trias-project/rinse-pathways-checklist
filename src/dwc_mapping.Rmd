---
title: "Darwin Core mapping"
subtitle: "For: RINSE - pathways and vectors of biological invasions in Northwest Europe"
author:
- Lien Reyserhove
- Peter Desmet
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
    number_sections: true
---

This document describes how we map the checklist data to Darwin Core. The source file for this document can be found [here](https://github.com/trias-project/alien-plants-belgium/tree/master/data/raw).

# Setup

```{r setup, echo = FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

Set locale (so we use UTF-8 character encoding):

```{r}
# This works on Mac OS X, might not work on other OS
Sys.setlocale("LC_CTYPE", "en_US.UTF-8")
```

Load libraries:

```{r}
library(tidyverse) # To transform data
library(magrittr)  # For %<>% pipes
library(janitor)   # To clean input data
library(readxl)    # To read Excel files
library(stringr)   # To perform string operations
library(digest)    # To generate hashes
library(rgbif)     # Interface to the GBIF API
```

Set file paths (all paths should be relative to this script):
 
```{r}
# Raw files:
raw_data_file = "../data/raw/copy_of_10530_2016_1278_MOESM2_ESM.xlsx"

# Processed files:
dwc_taxon_file = "../data/processed/taxon.csv"
dwc_distribution_file = "../data/processed/distribution.csv"
dwc_profile_file = "../data/processed/speciesprofile.csv"
dwc_description_file = "../data/processed/description.csv"
```

# Read and pre-process raw data

Create a data frame `raw_data` from the source data:

```{r}
raw_data <- read_excel(path = raw_data_file) 
```

Clean the data somewhat: remove empty rows if present and clean names:

```{r}
raw_data %<>% remove_empty_rows() %<>%     # Remove empty rows
  clean_names()
```

## Clean scientific name

```{r}
parsed_names <- parsenames(raw_data $ species)
```

Some errors were detected:

```{r}
raw_data %<>% mutate(species_clean = case_when(
  species == "Crassostrea rhizophoraeGuilding 1828" ~ "Crassostrea rhizophorae Guilding 1828",
  species == "Petricola pholadiformisLamarck, 1818" ~ "Petricola pholadiformis Lamarck, 1818",
  species == "Theba pisanaMüller, 1774)" ~ "Theba pisana (Müller, 1774)")) 
```

## Generate taxonID

To uniquely identify a taxon in the taxon core and reference taxa in the extensions, we need a `taxonID`. Since we need it in all generated files, we generate it here in the raw data frame. It is a combination of `dataset-shortname:taxon:` and a hash based on the scientific name. As long as the scientific name doesn't change, the ID will be stable:

```{r}
# Vectorize the digest function (The digest() function isn't vectorized. So if you pass in a vector, you get one value for the whole vector rather than a digest for each element of the vector):
vdigest <- Vectorize(digest)

# Generate taxonID:
raw_data %<>% mutate(taxonID = paste("rinse-pathways-checklist", "taxon", vdigest (species_clean, algo="md5"), sep=":"))
```

## Further pre-processing:

Add prefix `raw_` to all column names to avoid name clashes with Darwin Core terms:

```{r}
colnames(raw_data) <- paste0("raw_", colnames(raw_data))
```

Preview data:

```{r}
raw_data %>% head()
```

# Create taxon core

```{r start_taxon}
taxon <- raw_data
```

## Term mapping
 
Map the data to [Darwin Core Taxon](http://rs.gbif.org/core/dwc_taxon_2015-04-24.xml).
 
### language

```{r}
taxon %<>% mutate(language = "en")
```

### rightsHolder

```{r}
taxon %<>% mutate(rightsHolder = "University of Cambridge")
```

### datasetID

```{r}
taxon %<>% mutate(datasetID = "")
```

### datasetName

```{r}
taxon %<>% mutate(datasetName = "RINSE - pathways and vectors of biological invasions in Northwest Europe")
```

### bibliographicCitation

### taxonID

```{r}
taxon %<>% mutate(taxonID = raw_taxonID)
```

### scientificName

```{r}
taxon %<>% mutate(scientificName = raw_species_clean)
```

### kingdom

```{r}
taxon %>% distinct(raw_higher_classification)
```


```{r}
taxon %<>% mutate(kingdom = case_when(
  raw_higher_classification == "Angiospermae" ~ "Plantae" ,
  TRUE ~ "Animalia")) 
```

### phylum

```{r}
taxon %<>% mutate(phylum = case_when(
  raw_higher_classification == "Angiospermae" ~ "" ,
  raw_higher_classification == "Mollusca" ~ "Mollusca",
  TRUE ~ "Chordata")) 
```

### class

```{r}
taxon %<>% mutate(class = case_when(
  raw_higher_classification == "Anseriformes" ~ "Aves",
  raw_higher_classification == "Mammalia" ~ "Mammalia",
  TRUE ~ "")) 
```

### order

```{r}
taxon %<>% mutate(order = case_when(
  raw_higher_classification == "Anseriformes" ~ "Anseriformes",
  TRUE ~ "" )) 
```

### higherClassification

```{r}
taxon %<>% mutate(higherClassification = case_when(
  raw_higher_classification == "Angiospermae" ~ paste(kingdom, raw_higher_classification, sep = " | "),
  raw_higher_classification == "Mollusca" ~ paste(kingdom, phylum, sep = " | "),
  raw_higher_classification == "Osteichthyes" ~ paste(kingdom, phylum, raw_higher_classification, sep = " | "),
  raw_higher_classification == "Anseriformes" ~ paste(kingdom, phylum, class, order, sep = " | "),
  raw_higher_classification == "Mammalia" ~ paste(kingdom, phylum, class, sep = " | "))) 
```

### taxonRank

```{r}
taxonRank <- parsenames(taxon $ raw_species_clean)
```

```{r}
taxonRank %<>% select(scientificname, rankmarker, notho) 
```

```{r}
taxon %<>% left_join(taxonRank, by = c("raw_species_clean" = "scientificname")) 
```

```{r}
taxon %>% distinct(rankmarker) 
```

```{r}
taxon %<>% mutate(taxonRank = case_when(
  !is.na(notho) ~ "",
  rankmarker == "sp." & is.na(notho) ~ "species",
  rankmarker == "infrasp." ~ "subspecies",
  is.na(rankmarker) ~ "species")) 
```

## Post-processing

Remove the original columns:

```{r}
taxon %<>% select(-starts_with("raw_"), -rankmarker, - notho)
```

Preview data:

```{r}
head(taxon)
```

Save to CSV:

```{r}
write.csv(taxon, file = dwc_taxon_file, na = "", row.names = FALSE, fileEncoding = "UTF-8")
```

# Create distribution extension

Map the data to [Species Distribution](http://rs.gbif.org/extension/gbif/1.0/distribution.xml).

```{r}
distribution <- raw_data
```

### pre-processing

Check wether each record for which `raw_presence_gb` = NA --> raw_first_record_gb = NA

```{r}
distribution %>% filter((is.na(raw_established_gb) & !is.na(raw_first_record_gb))) 
```

```{r}
distribution %>% filter((is.na(raw_established_france) & !is.na(raw_first_record_france)))
```

```{r}
distribution %>% filter((is.na(raw_established_belgium) & !is.na(raw_first_record_belgium)))
```

```{r}
distribution %>% filter((is.na(raw_established_netherlands) & !is.na(raw_first_record_netherlands)))
```

Paste date and establishment information for each country:

```{r}
distribution %<>% mutate(record_gb = paste(raw_established_gb, raw_first_record_gb, sep = ",")) 
```

```{r}
distribution %<>% mutate(record_fr = paste(raw_established_france, raw_first_record_france, sep = ",")) 
```

```{r}
distribution %<>% mutate(record_be = paste(raw_established_belgium, raw_first_record_belgium, sep = ",")) 
```

```{r}
distribution %<>% mutate(record_nl = paste(raw_established_netherlands, raw_first_record_netherlands, sep = ",")) 
```

Frow wide to long dataset:

```{r}
distribution %<>% gather("country", "date", record_gb, record_fr, record_be, record_nl) 
```

Remove records with `NA,NA`:

```{r}
distribution %<>% filter(date != "NA,NA") 
```

Clean `data`:

```{r}
distribution %<>% mutate(date = str_replace_all(date, "Y,", "")) 
```

Rename `country`:

```{r}
distribution %<>% mutate(country = recode(country,
  "record_gb" = "Great Britain",
  "record_fr" = "France",
  "record_be" = "Belgium",
  "record_nl" = "The Netherlands"))
```

## Term mapping

### taxonID

```{r}
distribution %<>% mutate(taxonID = raw_taxonID)
```

### locationID

```{r}
distribution %<>% mutate(locationID = case_when(
   country == "Great Britain" ~ "ISO_3166-2:GB",
   country == "France" ~ "ISO_3166-2:FR",
   country == "Belgium" ~ "ISO_3166-2:BE",
   country == "The Netherlands" ~ "ISO_3166-2:NL"))
```

### locality

```{r}
distribution %<>% mutate(locality = country)
```

### countryCode

```{r}
distribution %<>% mutate(countryCode = case_when(
   country == "Great Britain" ~ "GB",
   country == "France" ~ "FR",
   country == "Belgium" ~ "BE",
   country == "The Netherlands" ~ "NL"))
```

### occurrenceStatus

```{r}
distribution %<>% mutate(occurrenceStatus = "present") 
```

### establishmentMeans

```{r}
distribution %<>% mutate(establishmentMeans = "established") 
```

### eventDate

Inspect dates:

```{r}
distribution %>% distinct(date) %>% arrange(date)
```

Clean whitespace information:

```{r}
unique(distribution[which(str_detect(distribution $ date,"^[0-9]{4}$") == FALSE), "date"])
```


```{r}
distribution %<>% mutate(date = str_trim(date)) 
```


```{r}
distribution %<>% mutate(date = recode(date,
   "n.d."  = "",
   "17634" = "1763",
   "2004," = "2004",
   "n..d"  = "",
   "199"   = "1990",
   "1985," = "1985",
   "NA"    = "",
   "19204" = "1904")) 
```

```{r}
unique(distribution[which(str_detect(distribution $ date,"^[0-9]{4}$") == FALSE), "date"])
```

Make date range:

```{r}
distribution %<>% mutate(eventDate = case_when(
  date == "" ~ "",
  date != "" ~ paste(date, "2016", sep = "/"))) 
```

### source

## Post-processing

Remove the original columns:

```{r}
distribution %<>% select(-starts_with("raw_"), -country, -date)
```

Preview data:

```{r}
head(distribution)
```

Save to CSV:

```{r}
write.csv(distribution, file = dwc_distribution_file, na = "", row.names = FALSE, fileEncoding = "UTF-8")
```

